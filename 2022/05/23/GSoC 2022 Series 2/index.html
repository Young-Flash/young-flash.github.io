

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Flash">
  <meta name="keywords" content="">
  <title>GSoC 2022 Series - 2 - Blog of Flash</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"young-flash.github.io","root":"/","version":"1.8.6","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":10},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"lazyload":{"enable":true,"onlypost":false,"loading_img":"/img/loading.gif","offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Blog of Flash</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/decorative_pic/GSoC.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="GSoC 2022 Series - 2">
              
                GSoC 2022 Series - 2
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Flash
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-23 09:34" pubdate>
        2022年5月23日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      20
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">GSoC 2022 Series - 2</h1>
            
            <div class="markdown-body">
              <h2 id="系列导航"><a class="markdownIt-Anchor" href="#系列导航"></a> 系列导航</h2>
<ul>
<li><a href="https://young-flash.github.io/2022/05/21/GSoC%202022%20Series%201/">GSoC 2022 Series - 1</a></li>
<li><a href="https://young-flash.github.io/2022/05/23/GSoC%202022%20Series%202/">GSoC 2022 Series - 2</a></li>
<li><a href="https://young-flash.github.io/2022/07/02/GSoC%202022%20Series%203/">GSoC 2022 Series - 3</a></li>
<li><a href="https://young-flash.github.io/2022/09/08/GSoC%202022%20Series%204/">GSoC 2022 Series - 4</a></li>
</ul>
<h2 id="熟悉代码"><a class="markdownIt-Anchor" href="#熟悉代码"></a> 熟悉代码</h2>
<p>联系 mentor 后他让我去看 src/rpc 下的代码，JSON-RPC 协议以及 SCGI 协议的实现都在这里，原先只有 XML-RPC，mentor 为它增加了 JSON-RPC 的支持：根据 XML-RPC 中的接口定义了一个 IRPC 接口类，然后让原先的 XML RPC 以及新增的 JSON RPC 继承自这个接口，通过 RpcManager 将 RPC 请求根据其内容是 XML 还是 JSON 分派到对应的处理类中然后再返回结果。一开始看代码还是比较混的，画一下分析图对于理清类之间的关系和工作流程会很有帮助：</p>
<p><img src="/img/blog_pic/2022/rtorrent-jsonRPC.jpg" srcset="/img/loading.gif" alt="" /></p>
<p>此时的 RPC 的网络通信部分是由 SCGI 协议实现的，而这个项目的目标之一是将古老的 SCGI 协议替换为更加 Modern 的 Websocket 协议。当时我的想法是照猫画虎地增加 websockets.h、 <a target="_blank" rel="noopener" href="http://websockets.cc">websockets.cc</a> 这样两个文件去实现 Websocket 协议。彼时的我还不知道 SCGI 协议是基于 rTorrent 的核心依赖 libtorrent 中的 event loop 实现的，也不清楚代码中 <code>Scgi</code> 和 <code>SCgiTask</code> 这两个类的关系，后来花了更多时间去阅读代码，结合 libtorrent 中 event loop 部分的代码理解之后才理清楚：<code>Scgi</code> 和 <code>SCgiTask</code> 的关系类似于 reactor 模型中主线程和子线程的关系，<code>Scgi</code> 是 listener，<code>activate</code> 之后把自己放在 event loop 中，<code>event_read</code> 中将每一个可读事件封装为 <code>SCgiTask</code> 然后将其放入 event loop 中。</p>
<h2 id="uwebsockets-和-usockets"><a class="markdownIt-Anchor" href="#uwebsockets-和-usockets"></a> uWebsockets 和 uSockets</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/uNetworking/uWebSockets">uWebsockets</a> 是一个 C++ 纯头文件实现的 websocket 库，性能优越，API 很简洁优雅，github 上有 13 k starts，计划用这个库来引入 websocket，不过在编译安装这个库的过程中还是遇到了很多麻烦的。uWebsockets 能做到纯头文件实现是因为底层用于 uSockets 作为网络库，在实验室的 GPU 上编译 uWebSockets 时报错 <code>lto1: fatal error: bytecode stream in file ‘uSockets/gcd.o’ generated with GCC compiler older than 10.0 compilation terminated</code>。 想着是链接器版本太低于是安装新的链接器，结果编译安装新版 binutils-2.38；成功安装了新版链接器后还是不行；转而安装版本低于 10.0 的 gcc … 装了 9.2 版本的还是不行。。。。。。吃完饭后在 Fisher 的虚拟机那里试了一下，一下子就编译过了。。。回来装了个 20.04 的 ubutun 虚拟机然后果然编译成功了，接下来就完全在虚拟机中开发了。这个过程记录在了前面的<a href="https://young-flash.github.io/2022/03/27/uWebsockets%20%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">这篇博客</a>中。</p>
<p>弄完这些后我还用 uWebsockets 写了一个小 <a target="_blank" rel="noopener" href="https://github.com/Young-Flash/websockets-demo">demo</a> 然后给 mentor 看，现在看来这个 demo 真是有够简单的。。。mentor 指出了这个库不支持 unix domain socket，但是这项特性对于 rTorrent 来说很重要：</p>
<blockquote>
<p>The feature is essential because rTorrent RPC interface has arbitrary command execution capabilities but doesn’t have access control of its own. Unix socket could be access restricted as a file, much straightforward than a port.</p>
</blockquote>
<h2 id="unix-domain-socket"><a class="markdownIt-Anchor" href="#unix-domain-socket"></a> unix domain socket</h2>
<p>SCGI 的可以跑在 TCP/IP 的端口上，也可以跑在 unix domain socket 上，当时我还不知道什么是 unix domain socket，一番 Google 下来后才算有所了解。mentor 说跑在 unix domain socket 比较安全，希望 websocket 也能跑在 unix domain socket 上，但是 uWebsockets 不支持 unix domain socket，此时只有两个选择：一是自己为 uWebsockets 增加 unix domain socket 支持，而是另寻它库，当时觉得自己增加 unix domain socket 支持肯定很难就去寻找其他库。试了 libwebsocket，有 unix domain socket 支持，不过是 C 写的，mentor 说接口 old-style，确实很难看懂。他建议我去实现 uWebsockets 的 unix domain socket 支持，查了一些资料，感觉也还是没啥思路。转而去寻找是否有其他支持 Unix domain socket 的 Websockets 实现，看了 websocketpp 和 boost 的 websocket 好像都没有。</p>
<p>结果最后只能硬着头皮尝试在 uWebsockets 上实现这项特性，首先在 uWebsockets 和 uSockets 中翻遍了所有跟 unix domain socket 有关的 issue，确实有那么几个，其中对我有启发的是<a target="_blank" rel="noopener" href="https://github.com/uNetworking/uWebSockets/issues/1364">这个</a>，让我知道了从 uSockets 的 <code>bsd.c</code> 这个文件中的创建 socket 部分入手，接着还在 uWebsockets 中提了一个 <a target="_blank" rel="noopener" href="https://github.com/uNetworking/uWebSockets/discussions/1438">discussion</a>，@了好多人都没人理我。。。实际动手操作后竟然真的让我做出来了，比想象中的简单许多，这也得益于 uWebsockets 本身的设计和编码都很优秀。在 uSockets 中提了 <a target="_blank" rel="noopener" href="https://github.com/uNetworking/uSockets/pull/178">PR</a>，想着这要是能合进去了那可就太棒了，不过作者认为这还不够，需要考虑兼容其他协议（其实作者的意思我也不太理解），这 PR 就先放着吧，日后有时间再 work on it</p>
<h2 id="qualification-task"><a class="markdownIt-Anchor" href="#qualification-task"></a> qualification task</h2>
<p>mentor 后来发布了 qualification task：</p>
<blockquote>
<p>Implement a minimal WebSockets -&gt; SCGI “translator” program in C++. Note that you don’t have to implement it inside rTorrent, and you don’t have to worry about the complicated stuff like events. <a target="_blank" rel="noopener" href="https://gist.github.com/jesec/858daa0cfb3948b4209127550bf4fe1e">Here</a> is a simple JSON-RPC client for rTorrent. Currently it accepts command line arguments. Your task, basically, is to let it accept arguments from WebSockets instead. Alternatively, just passthrough the payload and pipe back the response.The experience you gained here will also help with the main project.</p>
</blockquote>
<p>感觉不太难，clone 了 mentor 给的 simple JSON-RPC client 想跑起来的时候遇到了问题：在尝试用 ip:port 连接 rtorrent 的时候总是报错 Failed to connect: -1，用 unix domain socket 连接的时候就正常，搞了很久还不知道是什么原因。。。后来在详细看代码才发现是 mentor 在 <code>sin-&gt;sin_port = ::htons(std::stoi(port))</code> 这里竟然写错了变量名。。。。。。slack 上联系他说了这个事情，问他是不是自己都没用 ip:port 跑过，果然如此。。。还在想着会不会也是 qualification task 的内容之一。</p>
<p>这个 task 我是很认真完成了的，放在了代码都放在了我 github 上，在<a target="_blank" rel="noopener" href="https://github.com/Young-Flash/translator">这里</a>可以看到。对于内部数据流转的这个设计甚至自我感觉良好哈哈哈哈哈哈哈</p>
<p><img src="/img/blog_pic/2022/%E6%B5%81%E7%A8%8B%E5%9B%BE.png" srcset="/img/loading.gif" alt="" /></p>
<h2 id="more"><a class="markdownIt-Anchor" href="#more"></a> more</h2>
<p>4 月 15 号的时候联系 mentor 说我为 uWebSockets 增加了 unix domain socket 的支持，并且计划向官方 repo 提 PR，不过 mentor 也说他  open to a custom fork so that shouldn’t be a big problem，这样的话就算 PR 不被 merge 的话也可以用我自己的 fork。5 月上旬提交了两个 commit，在 rTorrent 中引入了 websocket，支持 TCP/IP 端口以及 unix domain socket 的连接，跟 mentor 说了这事儿，得到反馈还不错，至此感觉应该没啥大问题了哈哈哈哈</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/GSoC/">GSoC</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%BC%80%E6%BA%90/">开源</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/02/GSoC%202022%20Series%203/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">GSoC 2022 Series - 3</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/21/GSoC%202022%20Series%201/">
                        <span class="hidden-mobile">GSoC 2022 Series - 1</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
    <div id="giscus" class="giscus"></div>
    <!-- <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"Young-Flash/young-flash.github.io","repo-id":"R_kgDOHN76ng","category":"Announcements","category-id":"DIC_kwDOHN76ns4CXf6t","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"theme":"preferred_color_scheme","lang":"zh-CN","input-position":"bottom"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script> -->

    <script src="https://giscus.app/client.js"
        data-repo="Young-Flash/young-flash.github.io"
        data-repo-id="R_kgDOHN76ng"
        data-category="Announcements"
        data-category-id="DIC_kwDOHN76ns4CXf6t"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
    </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>

              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>








  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
